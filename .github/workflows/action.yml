name: build

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

jobs:
  desktop:
    name: Build Desktop Bundles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: '${{ github.ref }}'
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install lxml
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build Desktop Bundles with Gradle
        run: ./gradlew -c settings.desktop.gradle buildAllBundles --no-configuration-cache
      - name: Verify dist directory
        id: verify-dist
        run: |
          if [ -d dist ] && [ "$(ls -A dist)" ]; then
            echo "dist directory exists and is not empty"
          else
            echo "dist directory is empty or does not exist"
            exit 1
          fi
      - name: Upload files in dist/ as separate artifacts
        run: |
          cd dist
          for file in *; do
            echo "Uploading $file as artifact"
            artifact_name="${file%.*}"  # Remove file extension for the artifact name
            echo "Artifact name: $artifact_name"
            # Use the GitHub Actions built-in artifact upload action
            echo "::set-output name=artifact_name::$artifact_name"
            echo "::set-output name=file_path::dist/$file"
          done
        id: upload_files

      - name: Upload each file as an artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.upload_files.outputs.artifact_name }}
          path: ${{ steps.upload_files.outputs.file_path }}


